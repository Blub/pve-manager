<IfModule mpm_prefork_module>
    StartServers 2
    MinSpareServers 1 
    MaxSpareServers 2
    MaxClients          50
    MaxRequestsPerChild 30
</IfModule>

ServerName localhost
ServerSignature Off
ServerTokens Prod
ServerAdmin root
AddDefaultCharset On

# Hint: Ajax use KeepAlive, which in effect disables MaxRequestsPerChild,
# so we need to disable KeepAlive to prevent exhaustive memory usage, or
# at least make sure that periodic updaters interval > KeepAliveTimeout 
# or maybe we should set "MaxKeepAliveRequests 20"

KeepAlive Off

DocumentRoot @WWW_ROOTDIR@
<Directory />
	Options FollowSymLinks
	AllowOverride None
</Directory>

<Directory @WWW_ROOTDIR@>
	Options FollowSymLinks MultiViews
	AllowOverride None
	Order allow,deny
	allow from all
</Directory>

ErrorLog /var/log/apache2/error.log

LogLevel warn

# do not log access to our ajax services
SetEnvIf Request_URI "^/ws/" dontlog

CustomLog /var/log/apache2/access.log combined env=!dontlog 

Alias /images/  @WWW_IMAGEDIR@/
Alias /css/ @WWW_CSSDIR@/
Alias /ext/ @WWW_EXTDIR@/
Alias /javascript/ /usr/share/javascript/
Alias /vncterm/ /usr/share/vncterm/
 
# avoid authentication when accessing favicon
Alias /favicon.ico @WWW_IMAGEDIR@/favicon.ico

PerlModule Embperl
EMBPERL_SESSION_ARGS "config=DB_File Lock=Semaphore"

AddType text/html .epl

PerlRequire @WWW_ROOTDIR@/startup.pl

PerlSetVar PVESatisfy any		
PerlSetVar PVEPath /	
PerlSetVar PVELoginScript /login.pl

PerlTransHandler PVE::URLRewrite
	
Alias /nrd/ /__no_real_dir__/
 
<Directory "@WWW_ROOTDIR@">
      AuthType PVE::AuthCookieHandler
      AuthName PVE
      PerlSetVar PVECookieName PVEAuthCookie
      #PerlSetVar AuthCookieDebug 5

      PerlAuthenHandler PVE::AuthCookieHandler->authenticate
      PerlAuthzHandler PVE::AuthCookieHandler->authorize

      require group root

      DirectoryIndex index.htm index.pl

      <FilesMatch ".*\.htm$">
	EMBPERL_APPNAME PVE
        EMBPERL_SYNTAX EmbperlBlocks
        EMBPERL_OBJECT_BASE base.epl
	EMBPERL_INPUT_ESCMODE 0
	EMBPERL_ESCMODE 0
        SetHandler  perl-script
        PerlHandler Embperl::Object
        Options     ExecCGI
      </FilesMatch>
      <FilesMatch ".*\.epl$">
        Order allow,deny
        Deny From all
      </FilesMatch>
      <FilesMatch ".*\.pl$">
        SetHandler perl-script
	PerlHandler ModPerl::Registry
     	Options +ExecCGI
      </FilesMatch>

</Directory>

<Location /nrd/LOGIN>
      AuthType PVE::AuthCookieHandler
      AuthName PVE
      PerlSetVar PVECookieName PVEAuthCookie
      #PerlSetVar AuthCookieDebug 5
      SetHandler perl-script
      PerlHandler PVE::AuthCookieHandler->login
</Location>

<Location /ws/>
      SetHandler perl-script
      PerlHandler $PVE::HTMLServices::Obj->handler
</Location>

<VirtualHost *:443>

    SSLEngine on
    SSLProtocol all -SSLv2
    SSLCertificateFile @PROXMOX_ETC@/pve-ssl.pem
    SSLCertificateKeyFile @PROXMOX_ETC@/pve-ssl.key

    RewriteEngine on
    RewriteCond %{REQUEST_METHOD} ^(TRACE|TRACK)
    RewriteRule .* - [F]

 </VirtualHost>

<VirtualHost *:80>
    #RewriteLog "/root/rewrite.log"
    #RewriteLogLevel 10
    RewriteEngine on
    RewriteCond %{REQUEST_METHOD} ^(TRACE|TRACK)
    RewriteRule .* - [F]
    RewriteCond %{REQUEST_URI} !^/nrd/
    RewriteCond %{REQUEST_URI} !^/images/
    RewriteCond %{REQUEST_URI} !^/css/
    RewriteCond %{REQUEST_URI} !^/ext/
    RewriteCond %{REQUEST_URI} !^/javascript/
    RewriteCond %{REQUEST_URI} !^/vncterm/
    RewriteCond %{REQUEST_URI} !^/.*\.js$
    RewriteCond %{REQUEST_URI} !^/login.pl$
    RewriteRule ^/(.*) https://%{HTTP_HOST}/$1 [L,R]
</VirtualHost>

